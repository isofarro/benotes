{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 14, "column": 0}, "map": {"version":3,"sources":["file:///Users/miked/Projects-apps/benotes-app/packages/core/src/schema.ts"],"sourcesContent":["import { sqliteTable, text, integer, primaryKey } from 'drizzle-orm/sqlite-core';\nimport { sql } from 'drizzle-orm';\n\n// --- System Schema (Global) ---\n// Stored in system.db\n\nexport const tenants = sqliteTable('tenants', {\n  id: text('id').primaryKey(),\n  name: text('name').notNull(),\n  slug: text('slug').notNull().unique(), // subdomain or path\n  createdAt: integer('created_at', { mode: 'timestamp' }).default(sql`(strftime('%s', 'now'))`),\n});\n\nexport const users = sqliteTable('users', {\n  id: text('id').primaryKey(),\n  name: text('name'),\n  email: text('email').notNull().unique(),\n  emailVerified: integer('email_verified', { mode: 'timestamp' }),\n  image: text('image'),\n});\n\n// NextAuth Tables (Simplified for now)\nexport const accounts = sqliteTable('accounts', {\n  id: text('id').primaryKey(),\n  userId: text('userId').notNull().references(() => users.id, { onDelete: 'cascade' }),\n  type: text('type').notNull(),\n  provider: text('provider').notNull(),\n  providerAccountId: text('providerAccountId').notNull(),\n  refresh_token: text('refresh_token'),\n  access_token: text('access_token'),\n  expires_at: integer('expires_at'),\n  token_type: text('token_type'),\n  scope: text('scope'),\n  id_token: text('id_token'),\n  session_state: text('session_state'),\n});\n\n// --- Tenant Schema (Per Tenant) ---\n// Stored in tenants/<id>/db.sqlite\n\nexport const pages = sqliteTable('pages', {\n  id: text('id').primaryKey(),\n  title: text('title').notNull(),\n  slug: text('slug').notNull(), // URL friendly\n  content: text('content'), // Markdown body\n  parentId: text('parent_id'), // Hierarchical\n  createdAt: integer('created_at', { mode: 'timestamp' }).default(sql`(strftime('%s', 'now'))`),\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).default(sql`(strftime('%s', 'now'))`),\n});\n\nexport const cards = sqliteTable('cards', {\n  id: text('id').primaryKey(),\n  pageId: text('page_id').references(() => pages.id, { onDelete: 'cascade' }),\n  type: text('type').notNull(), // e.g. 'chess:game', 'core:note'\n  plugin: text('plugin').notNull(), // e.g. 'chess'\n  content: text('content'), // JSON data specific to the card\n  metadata: text('metadata'), // JSON metadata\n  createdAt: integer('created_at', { mode: 'timestamp' }).default(sql`(strftime('%s', 'now'))`),\n});\n\nexport const tags = sqliteTable('tags', {\n  id: text('id').primaryKey(),\n  name: text('name').notNull().unique(),\n  color: text('color'),\n});\n\n\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AAAA;AAAA;AACA;;;AAKO,MAAM,UAAU,IAAA,wKAAW,EAAC,WAAW;IAC5C,IAAI,IAAA,2KAAI,EAAC,MAAM,UAAU;IACzB,MAAM,IAAA,2KAAI,EAAC,QAAQ,OAAO;IAC1B,MAAM,IAAA,2KAAI,EAAC,QAAQ,OAAO,GAAG,MAAM;IACnC,WAAW,IAAA,iLAAO,EAAC,cAAc;QAAE,MAAM;IAAY,GAAG,OAAO,CAAC,mJAAG,CAAC,uBAAuB,CAAC;AAC9F;AAEO,MAAM,QAAQ,IAAA,wKAAW,EAAC,SAAS;IACxC,IAAI,IAAA,2KAAI,EAAC,MAAM,UAAU;IACzB,MAAM,IAAA,2KAAI,EAAC;IACX,OAAO,IAAA,2KAAI,EAAC,SAAS,OAAO,GAAG,MAAM;IACrC,eAAe,IAAA,iLAAO,EAAC,kBAAkB;QAAE,MAAM;IAAY;IAC7D,OAAO,IAAA,2KAAI,EAAC;AACd;AAGO,MAAM,WAAW,IAAA,wKAAW,EAAC,YAAY;IAC9C,IAAI,IAAA,2KAAI,EAAC,MAAM,UAAU;IACzB,QAAQ,IAAA,2KAAI,EAAC,UAAU,OAAO,GAAG,UAAU,CAAC,IAAM,MAAM,EAAE,EAAE;QAAE,UAAU;IAAU;IAClF,MAAM,IAAA,2KAAI,EAAC,QAAQ,OAAO;IAC1B,UAAU,IAAA,2KAAI,EAAC,YAAY,OAAO;IAClC,mBAAmB,IAAA,2KAAI,EAAC,qBAAqB,OAAO;IACpD,eAAe,IAAA,2KAAI,EAAC;IACpB,cAAc,IAAA,2KAAI,EAAC;IACnB,YAAY,IAAA,iLAAO,EAAC;IACpB,YAAY,IAAA,2KAAI,EAAC;IACjB,OAAO,IAAA,2KAAI,EAAC;IACZ,UAAU,IAAA,2KAAI,EAAC;IACf,eAAe,IAAA,2KAAI,EAAC;AACtB;AAKO,MAAM,QAAQ,IAAA,wKAAW,EAAC,SAAS;IACxC,IAAI,IAAA,2KAAI,EAAC,MAAM,UAAU;IACzB,OAAO,IAAA,2KAAI,EAAC,SAAS,OAAO;IAC5B,MAAM,IAAA,2KAAI,EAAC,QAAQ,OAAO;IAC1B,SAAS,IAAA,2KAAI,EAAC;IACd,UAAU,IAAA,2KAAI,EAAC;IACf,WAAW,IAAA,iLAAO,EAAC,cAAc;QAAE,MAAM;IAAY,GAAG,OAAO,CAAC,mJAAG,CAAC,uBAAuB,CAAC;IAC5F,WAAW,IAAA,iLAAO,EAAC,cAAc;QAAE,MAAM;IAAY,GAAG,OAAO,CAAC,mJAAG,CAAC,uBAAuB,CAAC;AAC9F;AAEO,MAAM,QAAQ,IAAA,wKAAW,EAAC,SAAS;IACxC,IAAI,IAAA,2KAAI,EAAC,MAAM,UAAU;IACzB,QAAQ,IAAA,2KAAI,EAAC,WAAW,UAAU,CAAC,IAAM,MAAM,EAAE,EAAE;QAAE,UAAU;IAAU;IACzE,MAAM,IAAA,2KAAI,EAAC,QAAQ,OAAO;IAC1B,QAAQ,IAAA,2KAAI,EAAC,UAAU,OAAO;IAC9B,SAAS,IAAA,2KAAI,EAAC;IACd,UAAU,IAAA,2KAAI,EAAC;IACf,WAAW,IAAA,iLAAO,EAAC,cAAc;QAAE,MAAM;IAAY,GAAG,OAAO,CAAC,mJAAG,CAAC,uBAAuB,CAAC;AAC9F;AAEO,MAAM,OAAO,IAAA,wKAAW,EAAC,QAAQ;IACtC,IAAI,IAAA,2KAAI,EAAC,MAAM,UAAU;IACzB,MAAM,IAAA,2KAAI,EAAC,QAAQ,OAAO,GAAG,MAAM;IACnC,OAAO,IAAA,2KAAI,EAAC;AACd"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///Users/miked/Projects-apps/benotes-app/packages/core/src/db.ts"],"sourcesContent":["import Database from 'better-sqlite3';\nimport { drizzle } from 'drizzle-orm/better-sqlite3';\nimport { sql } from 'drizzle-orm';\nimport path from 'path';\nimport fs from 'fs';\nimport * as schema from './schema';\n\n// Environment variable for data directory\nconst DATA_DIR = process.env.DATA_DIR || path.join(process.cwd(), '../../data');\n\n// Ensure data directory exists\nif (!fs.existsSync(DATA_DIR)) {\n  fs.mkdirSync(DATA_DIR, { recursive: true });\n}\n\n// Cache for database connections to avoid reopening\nconst dbCache: Record<string, ReturnType<typeof drizzle>> = {};\n\n/**\n * Get the Global System Database\n * Used for Tenants, Users, Auth\n */\nexport const getSystemDb = () => {\n  if (dbCache['system']) return dbCache['system'];\n\n  const systemDir = path.join(DATA_DIR, 'system');\n  if (!fs.existsSync(systemDir)) {\n    fs.mkdirSync(systemDir, { recursive: true });\n  }\n\n  const sqlite = new Database(path.join(systemDir, 'system.db'));\n  \n  // Bootstrap System Schema (Temporary for Walking Skeleton)\n  sqlite.exec(`\n    CREATE TABLE IF NOT EXISTS tenants (\n      id TEXT PRIMARY KEY,\n      name TEXT NOT NULL,\n      slug TEXT NOT NULL UNIQUE,\n      created_at INTEGER\n    );\n    CREATE TABLE IF NOT EXISTS users (\n      id TEXT PRIMARY KEY,\n      name TEXT,\n      email TEXT NOT NULL UNIQUE,\n      email_verified INTEGER,\n      image TEXT\n    );\n  `);\n\n  const db = drizzle(sqlite, { schema });\n  dbCache['system'] = db;\n  return db;\n};\n\n/**\n * Get a specific Tenant Database\n * Used for Pages, Cards, Plugins\n */\nexport const getTenantDb = (tenantId: string) => {\n  if (dbCache[tenantId]) return dbCache[tenantId];\n\n  const tenantDir = path.join(DATA_DIR, 'tenants', tenantId);\n  if (!fs.existsSync(tenantDir)) {\n    fs.mkdirSync(tenantDir, { recursive: true });\n  }\n\n  const sqlite = new Database(path.join(tenantDir, 'db.sqlite'));\n\n  // Bootstrap Tenant Schema (Temporary for Walking Skeleton)\n  sqlite.exec(`\n    CREATE TABLE IF NOT EXISTS pages (\n      id TEXT PRIMARY KEY,\n      title TEXT NOT NULL,\n      slug TEXT NOT NULL,\n      content TEXT,\n      parent_id TEXT,\n      created_at INTEGER,\n      updated_at INTEGER\n    );\n    CREATE TABLE IF NOT EXISTS cards (\n      id TEXT PRIMARY KEY,\n      page_id TEXT,\n      type TEXT NOT NULL,\n      plugin TEXT NOT NULL,\n      content TEXT,\n      metadata TEXT,\n      created_at INTEGER,\n      FOREIGN KEY (page_id) REFERENCES pages(id) ON DELETE CASCADE\n    );\n    CREATE TABLE IF NOT EXISTS tags (\n      id TEXT PRIMARY KEY,\n      name TEXT NOT NULL UNIQUE,\n      color TEXT\n    );\n  `);\n\n  const db = drizzle(sqlite, { schema });\n  dbCache[tenantId] = db;\n  return db;\n};\n\n/**\n * Helper to initialize a new tenant\n */\nexport const initTenant = (tenantId: string, name: string) => {\n    // 1. Create entry in System DB\n    const systemDb = getSystemDb();\n    \n    // Check if exists or Insert\n    // We use raw SQL for speed in this skeleton, or Drizzle\n    try {\n      systemDb.insert(schema.tenants).values({\n        id: tenantId,\n        name: name,\n        slug: tenantId\n      }).onConflictDoNothing().run();\n    } catch (e) {\n      console.error(\"Failed to register tenant in system DB\", e);\n    }\n    \n    // 2. Initialize Tenant DB (creates tables)\n    const db = getTenantDb(tenantId);\n    return db;\n};\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AAEA;AACA;AACA;;;;;;AAEA,0CAA0C;AAC1C,MAAM,WAAW,QAAQ,GAAG,CAAC,QAAQ,IAAI,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;AAElE,+BAA+B;AAC/B,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,WAAW;IAC5B,wGAAE,CAAC,SAAS,CAAC,UAAU;QAAE,WAAW;IAAK;AAC3C;AAEA,oDAAoD;AACpD,MAAM,UAAsD,CAAC;AAMtD,MAAM,cAAc;IACzB,IAAI,OAAO,CAAC,SAAS,EAAE,OAAO,OAAO,CAAC,SAAS;IAE/C,MAAM,YAAY,4GAAI,CAAC,IAAI,CAAC,UAAU;IACtC,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,YAAY;QAC7B,wGAAE,CAAC,SAAS,CAAC,WAAW;YAAE,WAAW;QAAK;IAC5C;IAEA,MAAM,SAAS,IAAI,8LAAQ,CAAC,4GAAI,CAAC,IAAI,CAAC,WAAW;IAEjD,2DAA2D;IAC3D,OAAO,IAAI,CAAC,CAAC;;;;;;;;;;;;;;EAcb,CAAC;IAED,MAAM,KAAK,IAAA,wKAAO,EAAC,QAAQ;QAAE,QAAA;IAAO;IACpC,OAAO,CAAC,SAAS,GAAG;IACpB,OAAO;AACT;AAMO,MAAM,cAAc,CAAC;IAC1B,IAAI,OAAO,CAAC,SAAS,EAAE,OAAO,OAAO,CAAC,SAAS;IAE/C,MAAM,YAAY,4GAAI,CAAC,IAAI,CAAC,UAAU,WAAW;IACjD,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,YAAY;QAC7B,wGAAE,CAAC,SAAS,CAAC,WAAW;YAAE,WAAW;QAAK;IAC5C;IAEA,MAAM,SAAS,IAAI,8LAAQ,CAAC,4GAAI,CAAC,IAAI,CAAC,WAAW;IAEjD,2DAA2D;IAC3D,OAAO,IAAI,CAAC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;EAyBb,CAAC;IAED,MAAM,KAAK,IAAA,wKAAO,EAAC,QAAQ;QAAE,QAAA;IAAO;IACpC,OAAO,CAAC,SAAS,GAAG;IACpB,OAAO;AACT;AAKO,MAAM,aAAa,CAAC,UAAkB;IACzC,+BAA+B;IAC/B,MAAM,WAAW;IAEjB,4BAA4B;IAC5B,wDAAwD;IACxD,IAAI;QACF,SAAS,MAAM,CAAC,4IAAc,EAAE,MAAM,CAAC;YACrC,IAAI;YACJ,MAAM;YACN,MAAM;QACR,GAAG,mBAAmB,GAAG,GAAG;IAC9B,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC,0CAA0C;IAC1D;IAEA,2CAA2C;IAC3C,MAAM,KAAK,YAAY;IACvB,OAAO;AACX"}},
    {"offset": {"line": 231, "column": 0}, "map": {"version":3,"sources":["file:///Users/miked/Projects-apps/benotes-app/packages/core/src/index.ts"],"sourcesContent":["export * from './schema';\nexport * from './db';\n"],"names":[],"mappings":";AAAA;AACA"}},
    {"offset": {"line": 240, "column": 0}, "map": {"version":3,"sources":["file:///Users/miked/Projects-apps/benotes-app/apps/web/app/page.tsx"],"sourcesContent":["import { getSystemDb, initTenant, getTenantDb, pages } from '@benotes/core';\nimport { sql } from 'drizzle-orm';\n\nexport default async function Home() {\n  // Test DB Connection\n  // 1. Ensure system DB\n  const sysDb = getSystemDb();\n  \n  // 2. Ensure a demo tenant\n  initTenant('demo', 'Demo Tenant');\n  \n  // 3. Get tenant DB\n  const db = getTenantDb('demo');\n  \n  // 4. Query\n  // Note: .get() is for better-sqlite3 direct usage, but with Drizzle we use .all() or destructure\n  // Drizzle with better-sqlite3 supports .get() if using the right driver setup\n  const result = await db.select({ count: sql<number>`count(*)` }).from(pages);\n  const pageCount = result[0]?.count ?? 0;\n\n  return (\n    <main className=\"p-8\">\n      <h1 className=\"text-2xl font-bold mb-4\">Benotes App</h1>\n      <div className=\"p-4 border rounded bg-gray-50\">\n        <h2 className=\"font-semibold\">System Status</h2>\n        <ul className=\"list-disc list-inside mt-2\">\n           <li>System DB: Connected</li>\n           <li>Tenant 'demo': Initialized</li>\n           <li>Page Count: {pageCount}</li>\n        </ul>\n      </div>\n    </main>\n  );\n}\n"],"names":[],"mappings":";;;;;AAAA;AAAA;AAAA;AACA;;;;AAEe,eAAe;IAC5B,qBAAqB;IACrB,sBAAsB;IACtB,MAAM,QAAQ,IAAA,4IAAW;IAEzB,0BAA0B;IAC1B,IAAA,2IAAU,EAAC,QAAQ;IAEnB,mBAAmB;IACnB,MAAM,KAAK,IAAA,4IAAW,EAAC;IAEvB,WAAW;IACX,iGAAiG;IACjG,8EAA8E;IAC9E,MAAM,SAAS,MAAM,GAAG,MAAM,CAAC;QAAE,OAAO,mJAAG,AAAQ,CAAC,QAAQ,CAAC;IAAC,GAAG,IAAI,CAAC,0IAAK;IAC3E,MAAM,YAAY,MAAM,CAAC,EAAE,EAAE,SAAS;IAEtC,qBACE,8OAAC;QAAK,WAAU;;0BACd,8OAAC;gBAAG,WAAU;0BAA0B;;;;;;0BACxC,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBAAG,WAAU;kCAAgB;;;;;;kCAC9B,8OAAC;wBAAG,WAAU;;0CACX,8OAAC;0CAAG;;;;;;0CACJ,8OAAC;0CAAG;;;;;;0CACJ,8OAAC;;oCAAG;oCAAa;;;;;;;;;;;;;;;;;;;;;;;;;AAK5B"}}]
}